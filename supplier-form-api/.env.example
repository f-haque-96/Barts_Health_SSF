# NHS Supplier Setup Form API - Environment Variables
# Copy this file to .env and fill in the values
#
# ⚠️  UPDATED: February 3, 2026 - New REQUIRED variables added
# ⚠️  The API will NOT start if required variables are missing
#
# CRITICAL CHANGES:
# - SESSION_SECRET is now REQUIRED (no default value)
# - Environment validation added (fails on startup if missing required vars)
# - CSRF protection enabled (requires SESSION_SECRET)
# - Enhanced security features require proper configuration

# ===========================================
# DATABASE CONFIGURATION (REQUIRED)
# ===========================================
DB_HOST=localhost
DB_PORT=1433
DB_NAME=SupplierSetupDB
DB_USER=supplier_form_api
DB_PASSWORD=<secure_password_here>
# Use Windows Authentication (set to true if on domain-joined server)
DB_TRUSTED_CONNECTION=false

# ===========================================
# SHAREPOINT CONFIGURATION
# ===========================================
SP_SITE_URL=https://nhs.sharepoint.com/sites/R1H_FIN_Legacy_Procurement
SP_CLIENT_ID=<from_app_registration>
SP_CLIENT_SECRET=<from_app_registration>
SP_TENANT_ID=<nhs_tenant_id>
# Document Libraries
SP_DOCS_LIBRARY=SupplierDocuments
SP_SENSITIVE_DOCS_LIBRARY=SensitiveDocuments
SP_STATUS_LIST=SubmissionStatus

# ===========================================
# AZURE AD / ADFS AUTHENTICATION
# ===========================================
AZURE_AD_TENANT_ID=<nhs_tenant_id>
AZURE_AD_CLIENT_ID=<app_client_id>
AZURE_AD_CLIENT_SECRET=<app_secret>
# For on-premise ADFS, use ADFS endpoint instead
# ADFS_METADATA_URL=https://adfs.bartshealth.nhs.uk/FederationMetadata/2007-06/FederationMetadata.xml

# ===========================================
# ALEMBA INTEGRATION
# ===========================================
ALEMBA_API_URL=https://servicedeskbartshealth.alembacloud.com/api
ALEMBA_API_KEY=<alemba_api_key>
# Alemba field mappings (for ticket closure)
ALEMBA_CLOSURE_STATUS=Closed
ALEMBA_RESOLUTION_CODE=Resolved

# ===========================================
# COMPANIES HOUSE API
# ===========================================
CH_API_KEY=<companies_house_api_key>
CH_API_URL=https://api.company-information.service.gov.uk

# ===========================================
# SERVER CONFIGURATION (REQUIRED)
# ===========================================
NODE_ENV=production
API_PORT=3001

# CORS - Frontend URL(s), comma-separated
CORS_ORIGIN=https://weshare.bartshealth.nhs.uk

# ⚠️  CRITICAL - SESSION_SECRET is REQUIRED (no default)
# Used for session cookies and CSRF token signing
# Generate a random 32+ character string using one of these methods:
#
# Option 1 (Node.js):
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#
# Option 2 (OpenSSL):
#   openssl rand -hex 32
#
# Option 3 (PowerShell on Windows):
#   -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | % {[char]$_})
#
# NEVER use a default or weak value - the API will refuse to start if this is missing
SESSION_SECRET=<REPLACE_WITH_GENERATED_SECRET>

# ===========================================
# SECURITY (Enhanced - February 2026)
# ===========================================
# Rate limiting (requests per minute per IP)
RATE_LIMIT_MAX=100

# File upload limits (in bytes) - 10MB default
MAX_FILE_SIZE=10485760

# Allowed file types (comma-separated)
# NOTE: File type validation now uses magic number checking (file signatures)
# to prevent MIME type spoofing attacks - declared types must match actual file content
ALLOWED_FILE_TYPES=.pdf,.png,.jpg,.jpeg,.doc,.docx

# ✅ NEW SECURITY FEATURES ENABLED:
# - CSRF protection (requires SESSION_SECRET)
# - Content Security Policy headers configured
# - Server-side validation on all POST/PUT routes
# - Magic number file validation (prevents MIME spoofing)
# - Enhanced health check with dependency verification
# - Environment variable validation on startup

# ===========================================
# LOGGING
# ===========================================
LOG_LEVEL=info
# Log file path (relative to server root)
LOG_FILE_PATH=./logs/app.log

# ===========================================
# NOTIFICATIONS (Power Automate)
# ===========================================
# Power Automate webhook URL for email notifications
PA_NOTIFICATION_WEBHOOK=<power_automate_webhook_url>

# AP Control Email (for vendor number assignment notifications)
AP_CONTROL_EMAIL=ap.control@bartshealth.nhs.uk
